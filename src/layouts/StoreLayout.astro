---
import { createClient } from '@supabase/supabase-js';
import '../styles/tailwind.css';
import FlashOfferUI from '../components/islands/FlashOfferUI.tsx';
import Footer from '../components/Footer.astro';
import { getBrand } from '../lib/brand';

export const prerender = false;

interface Props {
	title?: string;
	showAuth?: boolean;
}

const { title = 'Fashion Store', showAuth = true } = Astro.props;

const brand = getBrand();

let loggedIn = false;
let userEmail: string | null = null;

if (showAuth) {
	const accessToken = Astro.cookies.get('sb-access-token')?.value;
	if (accessToken) {
		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const anonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		if (supabaseUrl && anonKey) {
			const authSb = createClient(supabaseUrl, anonKey, {
				auth: { persistSession: false, autoRefreshToken: false },
				global: { headers: { Authorization: `Bearer ${accessToken}` } },
			});
			const { data } = await authSb.auth.getUser();
			if (data.user) {
				loggedIn = true;
				userEmail = data.user.email ?? null;
			}
		}
	}
}
---

<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{title}</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
		<style is:global>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				background: #fff;
				color: #111;
				line-height: 1.6;
				-webkit-font-smoothing: antialiased;
			}

			a {
				color: inherit;
				text-decoration: none;
			}

			button {
				font-family: inherit;
			}

			/* Typography */
			.text-xs { font-size: 0.75rem; }
			.text-sm { font-size: 0.875rem; }
			.text-base { font-size: 1rem; }
			.text-lg { font-size: 1.125rem; }
			.text-xl { font-size: 1.25rem; }
			.text-2xl { font-size: 1.5rem; }
			.text-3xl { font-size: 1.875rem; }
			.text-4xl { font-size: 2.25rem; }

			.font-light { font-weight: 300; }
			.font-normal { font-weight: 400; }
			.font-medium { font-weight: 500; }
			.font-semibold { font-weight: 600; }

			.uppercase { text-transform: uppercase; }
			.tracking-wide { letter-spacing: 0.05em; }
			.tracking-wider { letter-spacing: 0.1em; }

			.text-gray-400 { color: #9ca3af; }
			.text-gray-500 { color: #6b7280; }
			.text-gray-600 { color: #4b5563; }
			.text-gray-900 { color: #111827; }

			/* Reduced motion */
			@media (prefers-reduced-motion: reduce) {
				*, *::before, *::after {
					animation-duration: 0.01ms !important;
					animation-iteration-count: 1 !important;
					transition-duration: 0.01ms !important;
				}
			}

			/* Buttons */
			.btn-primary {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				padding: 0.875rem 2rem;
				background: #111;
				color: #fff;
				font-size: 0.8125rem;
				font-weight: 500;
				letter-spacing: 0.1em;
				text-transform: uppercase;
				border: 1px solid #111;
				cursor: pointer;
				transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
			}

			.btn-primary:hover {
				background: #000;
				transform: scale(1.03);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}

			.btn-primary:active {
				transform: scale(1);
			}

			.btn-primary:focus-visible {
				outline: 2px solid #111;
				outline-offset: 2px;
			}

			.btn-primary:disabled {
				background: #d1d5db;
				border-color: #d1d5db;
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			.btn-secondary {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				padding: 0.875rem 2rem;
				background: #fff;
				color: #111;
				font-size: 0.8125rem;
				font-weight: 500;
				letter-spacing: 0.1em;
				text-transform: uppercase;
				border: 1px solid #111;
				cursor: pointer;
				transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
			}

			.btn-secondary:hover {
				background: #fafafa;
				transform: scale(1.03);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
			}

			.btn-secondary:active {
				transform: scale(1);
			}

			.btn-secondary:focus-visible {
				outline: 2px solid #111;
				outline-offset: 2px;
			}

			.btn-secondary:disabled {
				color: #9ca3af;
				border-color: #d1d5db;
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}

			.btn-link {
				display: inline-flex;
				align-items: center;
				background: none;
				border: none;
				color: #111;
				font-size: 0.8125rem;
				font-weight: 400;
				cursor: pointer;
				transition: color 0.15s ease;
			}

			.btn-link:hover {
				color: #6b7280;
			}

			.btn-link:focus-visible {
				outline: 2px solid #111;
				outline-offset: 2px;
			}

			/* Product Cards */
			.product-card {
				display: flex;
				flex-direction: column;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			.product-card:hover {
				transform: translateY(-3px);
				box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
			}

			.product-card-image {
				width: 100%;
				aspect-ratio: 3/4;
				object-fit: cover;
				background: #f5f5f5;
				transition: transform 0.3s ease;
			}

			.product-card:hover .product-card-image {
				transform: scale(1.03);
			}

			.product-card-image-wrapper {
				overflow: hidden;
				margin-bottom: 1rem;
			}

			/* Category blocks */
			.category-block {
				position: relative;
				overflow: hidden;
				display: block;
				aspect-ratio: 4/5;
				background: #f5f5f5;
			}

			.category-block-image {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transition: transform 0.4s ease;
			}

			.category-block:hover .category-block-image {
				transform: scale(1.05);
			}

			.category-block-overlay {
				position: absolute;
				inset: 0;
				background: rgba(0, 0, 0, 0.25);
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				color: #fff;
				text-align: center;
				transition: background 0.3s ease;
			}

			.category-block:hover .category-block-overlay {
				background: rgba(0, 0, 0, 0.35);
			}

			.category-block-title {
				font-size: 1.5rem;
				font-weight: 400;
				letter-spacing: 0.15em;
				text-transform: uppercase;
				margin: 0;
			}

			.category-block-subtitle {
				font-size: 0.75rem;
				letter-spacing: 0.1em;
				text-transform: uppercase;
				margin-top: 0.5rem;
				opacity: 0.85;
			}

			/* Forms */
			.form-input {
				width: 100%;
				padding: 0.875rem 1rem;
				font-size: 0.875rem;
				border: 1px solid #e5e7eb;
				background: #fff;
				transition: border-color 0.2s ease;
			}

			.form-input:focus {
				outline: none;
				border-color: #111;
			}

			.form-label {
				display: block;
				font-size: 0.75rem;
				font-weight: 500;
				letter-spacing: 0.05em;
				text-transform: uppercase;
				color: #6b7280;
				margin-bottom: 0.5rem;
			}

			/* Alerts */
			.alert {
				padding: 1rem;
				font-size: 0.875rem;
				border: 1px solid;
			}

			.alert-error {
				background: #fef2f2;
				border-color: #fecaca;
				color: #991b1b;
			}

			.alert-success {
				background: #f0fdf4;
				border-color: #bbf7d0;
				color: #166534;
			}

			/* Container */
			.container {
				width: 100%;
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 1.5rem;
			}

			.container-sm {
				max-width: 480px;
			}

			.container-md {
				max-width: 768px;
			}

			/* ========================================
			   FX UTILITIES - Micro-animations globales
			   ======================================== */

			/* Hover scale + shadow - para botones y elementos clickables */
			.fx-hover {
				transition: transform 0.15s ease, box-shadow 0.15s ease;
			}
			.fx-hover:hover {
				transform: scale(1.02);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			}
			.fx-hover:active {
				transform: scale(1);
			}
			.fx-hover:focus-visible {
				outline: 2px solid #111;
				outline-offset: 3px;
			}

			/* Card lift - para tarjetas de producto */
			.fx-card {
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}
			.fx-card:hover {
				transform: translateY(-4px);
				box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
			}

			/* Image zoom - para imagenes dentro de contenedores con overflow:hidden */
			.fx-img-wrap {
				overflow: hidden;
				border-radius: 14px;
				background: #f3f4f6;
			}

			.fx-img-wrap img {
				display: block;
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.fx-img-zoom {
				transition: transform 0.18s ease;
				transform: scale(1);
				will-change: transform;
			}
			.fx-img-wrap:hover .fx-img-zoom {
				transform: scale(1.06);
			}

			/* Pop animation - para modales y toasts */
			.fx-pop {
				animation: fxPopIn 0.2s ease-out;
			}
			@keyframes fxPopIn {
				from {
					opacity: 0;
					transform: scale(0.95) translateY(-8px);
				}
				to {
					opacity: 1;
					transform: scale(1) translateY(0);
				}
			}

			/* Fade in animation */
			.fx-fade-in {
				animation: fxFadeIn 0.2s ease-out;
			}
			@keyframes fxFadeIn {
				from { opacity: 0; }
				to { opacity: 1; }
			}

			/* Slide up animation */
			.fx-slide-up {
				animation: fxSlideUp 0.25s ease-out;
			}
			@keyframes fxSlideUp {
				from {
					opacity: 0;
					transform: translateY(12px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			/* Width utility */
			.w-full { width: 100%; }

			/* Header wordmark (minimal luxury) */
			.header-wordmark {
				font-size: 1.05rem;
				font-weight: 300;
				letter-spacing: 0.26em;
				text-transform: uppercase;
				color: #111;
				white-space: nowrap;
				line-height: 1;
			}

			@media (max-width: 768px) {
				.header-wordmark {
					font-size: 0.95rem;
					letter-spacing: 0.22em;
				}
			}
		</style>
	</head>
	<body>
		<FlashOfferUI client:only="preact" />
		<!-- Header -->
		<header
			style="position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #e5e7eb; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: 0 1px 2px rgba(0,0,0,0.04);"
		>
			<div class="container" style="display: flex; align-items: center; justify-content: space-between; height: 60px; gap: 1rem;">
				<a href="/" style="display: flex; align-items: center; gap: 0.75rem;">
					<img
						src="/logo3.png"
						alt={brand.name}
						loading="eager"
						style="height: 42px; width: auto; object-fit: contain; display: block;"
					/>
					<span class="header-wordmark">Fashion Store</span>
				</a>

				<nav style="display: flex; align-items: center; gap: 2rem;">
					<a
						href="/productos"
						style="font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
						onmouseover="this.style.color='#6b7280'"
						onmouseout="this.style.color='#111'"
					>
						Productos
					</a>
					<a
						id="nav-ofertas"
						href="/productos?flash=1"
						style="display:none;font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
						onmouseover="this.style.color='#6b7280'"
						onmouseout="this.style.color='#111'"
					>
						OFERTAS
					</a>
					<a
						href="/carrito"
						style="font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
						onmouseover="this.style.color='#6b7280'"
						onmouseout="this.style.color='#111'"
					>
						Carrito
					</a>
					{loggedIn && (
						<a
							href="/cuenta"
							style="font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
							onmouseover="this.style.color='#6b7280'"
							onmouseout="this.style.color='#111'"
						>
							Cuenta
						</a>
					)}
				</nav>

				<div style="display: flex; align-items: center; gap: 1.5rem;">
					{loggedIn ? (
						<>
							{userEmail && <span style="font-size: 0.75rem; color: #6b7280;">{userEmail}</span>}
							<form method="POST" action="/auth/logout" style="margin: 0;">
								<button type="submit" class="btn-link">Salir</button>
							</form>
						</>
					) : (
						<>
							<a
								href="/auth/login"
								style="font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
								onmouseover="this.style.color='#6b7280'"
								onmouseout="this.style.color='#111'"
							>
								Login
							</a>
							<a
								href="/auth/register"
								style="font-size: 0.8125rem; letter-spacing: 0.05em; text-transform: uppercase; transition: color 0.2s;"
								onmouseover="this.style.color='#6b7280'"
								onmouseout="this.style.color='#111'"
							>
								Registro
							</a>
						</>
					)}
				</div>
			</div>
		</header>

		<!-- Main -->
		<main>
			<slot />
		</main>

		<script>
			(() => {
				const el = document.getElementById('nav-ofertas');
				if (!(el instanceof HTMLAnchorElement)) return;
				fetch('/api/flash-offer', { method: 'GET' })
					.then((r) => r.json())
					.then((data) => {
						if (data && data.active) {
							el.style.display = '';
						}
					})
					.catch(() => {});
			})();
		</script>

		<Footer />
	</body>
</html>
