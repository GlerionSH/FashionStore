---
import StoreLayout from '../layouts/StoreLayout.astro';
import { supabase } from '../lib/supabase';
import AddToCartButton from '../components/islands/AddToCartButton.tsx';
import CartPanel from '../components/islands/CartPanel.tsx';
import { applyPercentDiscountCents, getActiveFlashOffer } from '../lib/flashOffer';
import { formatPriceEURFromCents } from '../lib/price';
import { getBrand } from '../lib/brand';
import { getHeroImage, getCategoryImages } from '../lib/homeImages';
import HeroEditorial from '../components/HeroEditorial.astro';
import CategoryBlock from '../components/CategoryBlock.astro';

export const prerender = false;

type SiteSettingsRow = {
	flash_offers_enabled: boolean;
};

type ProductRow = {
	id: string;
	name: string;
	slug?: string;
	price_cents: number;
	stock: number;
	images?: unknown;
};

const sb = supabase as any;

const brand = getBrand();

const heroImage = getHeroImage();

const { data: settingsData } = await sb
	.from('fs_settings')
	.select('flash_offers_enabled')
	.eq('singleton', true)
	.maybeSingle();

const settings: SiteSettingsRow | null = settingsData ?? null;
const flashOffersEnabled = settings?.flash_offers_enabled ?? false;

const categoryBlocks = getCategoryImages(flashOffersEnabled);

let flashProducts: ProductRow[] = [];
if (settings?.flash_offers_enabled) {
	const { data: flashData } = await sb
		.from('fs_products')
		.select('id,name,slug,price_cents,stock,images')
		.eq('is_active', true)
		.eq('is_flash', true)
		.order('price_cents', { ascending: true })
		.limit(4);

	flashProducts = flashData ?? [];

	if (flashProducts.length === 0) {
		const { data: fallbackData } = await sb
			.from('fs_products')
			.select('id,name,slug,price_cents,stock,images')
			.eq('is_active', true)
			.order('price_cents', { ascending: true })
			.limit(4);
		flashProducts = fallbackData ?? [];
	}
}

const { data: featuredData } = await sb
	.from('fs_products')
	.select('id,name,slug,price_cents,stock,images')
	.eq('is_active', true)
	.order('created_at', { ascending: false })
	.limit(8);

const featuredProducts: ProductRow[] = featuredData ?? [];

const formatPrice = (priceCents: number) => formatPriceEURFromCents(priceCents);

const activeOffer = await getActiveFlashOffer(sb);
const discountPercent = activeOffer?.discount_percent ?? 0;
---

<StoreLayout title="Fashion Store">
	<!-- Hero Editorial -->
	<HeroEditorial
		image={heroImage}
		eyebrow="Nueva Coleccion"
		title="Descubre tu estilo"
		subtitle="Piezas atemporales con calidad y elegancia"
		primaryCta={{ href: '/productos', label: 'Ver Productos' }}
		secondaryCta={{ href: '/carrito', label: 'Ver Carrito' }}
	/>

	<!-- Category Blocks -->
	<section class="categories-section">
		<div class="container">
			<div class="categories-grid">
				{categoryBlocks.map((cat) => (
					<CategoryBlock
						href={cat.href}
						image={cat.image}
						subtitle={cat.subtitle}
						title={cat.title}
					/>
				))}
			</div>
		</div>
	</section>

	<!-- Featured Products -->
	{featuredProducts.length > 0 && (
		<section class="featured-section">
			<div class="container">
				<div class="section-header">
					<h2 class="section-title">Destacados</h2>
					<a href="/productos" class="section-link">Ver todo</a>
				</div>
				<div class="products-grid">
					{featuredProducts.slice(0, 4).map((p) => {
						const imagesRaw = p.images;
						const images = Array.isArray(imagesRaw) ? (imagesRaw as string[]) : [];
						const imageUrl = images.length > 0 ? images[0] : undefined;
						const href = p.slug ? `/productos/${encodeURIComponent(p.slug)}` : '/productos';
						return (
							<article class="product-card">
								<a href={href} class="product-card-image-wrapper">
									{imageUrl ? (
										<img src={imageUrl} alt={p.name} class="product-card-image" loading="lazy" />
									) : (
										<div class="product-card-image"></div>
									)}
								</a>
								<a href={href} class="product-card-name">{p.name}</a>
								<p class="product-card-price">{formatPrice(p.price_cents)}</p>
							</article>
						);
					})}
				</div>
			</div>
		</section>
	)}

	<!-- Flash Products -->
	{settings?.flash_offers_enabled && flashProducts.length > 0 && (
		<section class="flash-section">
			<div class="container">
				<div class="section-header">
					<h2 class="section-title">Ofertas Flash</h2>
					<a href="/productos?flash=1" class="section-link">Ver todo</a>
				</div>
				<div class="products-grid">
					{flashProducts.map((p) => {
						const imagesRaw = p.images;
						const images = Array.isArray(imagesRaw) ? (imagesRaw as string[]) : [];
						const imageUrl = images.length > 0 ? images[0] : undefined;
						const href = p.slug ? `/productos/${encodeURIComponent(p.slug)}` : '/productos';
						const discounted = discountPercent > 0 ? applyPercentDiscountCents(p.price_cents, discountPercent) : p.price_cents;
						const hasDiscount = discountPercent > 0 && discounted < p.price_cents;
						return (
							<article class="product-card">
								<a href={href} class="product-card-image-wrapper">
									{imageUrl ? (
										<img src={imageUrl} alt={p.name} class="product-card-image" loading="lazy" />
									) : (
										<div class="product-card-image"></div>
									)}
								</a>
								<a href={href} class="product-card-name">{p.name}</a>
								<p class="product-card-price">
									{hasDiscount ? (
										<span class="price-discounted">
											<span class="price-original">{formatPrice(p.price_cents)}</span>
											<span class="price-current">{formatPrice(discounted)}</span>
											<span class="price-badge">-{discountPercent}%</span>
										</span>
									) : (
										<>{formatPrice(p.price_cents)}</>
									)}
								</p>
								<AddToCartButton client:load productId={p.id} name={p.name} priceCents={p.price_cents} stock={p.stock} imageUrl={imageUrl} />
							</article>
						);
					})}
				</div>
			</div>
		</section>
	)}

	<CartPanel client:only="preact" />
</StoreLayout>

<style>
	.categories-section {
		padding: 5rem 0;
	}

	.categories-grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 1.5rem;
	}

	@media (max-width: 768px) {
		.categories-grid {
			grid-template-columns: 1fr;
			gap: 1rem;
		}
	}

	.featured-section,
	.flash-section {
		padding: 4rem 0;
		border-top: 1px solid #e5e7eb;
	}

	.section-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 2.5rem;
	}

	.section-title {
		font-size: 0.8125rem;
		font-weight: 500;
		letter-spacing: 0.15em;
		text-transform: uppercase;
		margin: 0;
	}

	.section-link {
		font-size: 0.8125rem;
		color: #6b7280;
		text-decoration: underline;
		text-underline-offset: 3px;
		transition: color 0.15s ease;
	}

	.section-link:hover {
		color: #111;
	}

	.products-grid {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 2rem;
	}

	@media (max-width: 1024px) {
		.products-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (max-width: 480px) {
		.products-grid {
			grid-template-columns: 1fr;
			gap: 2.5rem;
		}
	}

	.product-card-name {
		font-size: 0.9375rem;
		font-weight: 400;
		color: #111;
		text-decoration: none;
		margin: 0 0 0.5rem;
		display: block;
		transition: color 0.15s ease;
	}

	.product-card-name:hover {
		color: #6b7280;
	}

	.product-card-price {
		font-size: 0.875rem;
		color: #111;
		margin: 0 0 1rem;
		font-weight: 500;
	}

	.price-discounted {
		display: inline-flex;
		align-items: baseline;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.price-original {
		color: #9ca3af;
		font-weight: 400;
		text-decoration: line-through;
	}

	.price-current {
		color: #111;
	}

	.price-badge {
		font-size: 0.6875rem;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		color: #111;
		background: #f5f5f5;
		padding: 0.125rem 0.375rem;
	}
</style>
