---
import StoreLayout from '../layouts/StoreLayout.astro';
import { supabase } from '../lib/supabase';
import AddToCartButton from '../components/islands/AddToCartButton.tsx';
import CartPanel from '../components/islands/CartPanel.tsx';
import { applyPercentDiscountCents, getActiveFlashOffer } from '../lib/flashOffer';
import { formatPriceEURFromCents } from '../lib/price';
import { getBrand, resolveHomeImage } from '../lib/brand';

export const prerender = false;

type SiteSettingsRow = {
	flash_offers_enabled: boolean;
};

type FlashProductRow = {
	id: string;
	name: string;
	slug?: string;
	price_cents: number;
	stock: number;
	images?: unknown;
};

const sb = supabase as any;

const brand = getBrand();

const heroImg = resolveHomeImage('PUBLIC_HOME_HERO_URL', '/hero.jpg');
const promo1Img = resolveHomeImage('PUBLIC_HOME_PROMO1_URL', '/promo1.jpg');
const promo2Img = resolveHomeImage('PUBLIC_HOME_PROMO2_URL', '/promo2.jpg');

const { data: settingsData } = await sb
	.from('fs_settings')
	.select('flash_offers_enabled')
	.eq('singleton', true)
	.maybeSingle();

const settings: SiteSettingsRow | null = settingsData ?? null;

let flashProducts: FlashProductRow[] = [];
if (settings?.flash_offers_enabled) {
	const { data: flashData } = await sb
		.from('fs_products')
		.select('id,name,slug,price_cents,stock,images')
		.eq('is_active', true)
		.eq('is_flash', true)
		.order('price_cents', { ascending: true })
		.limit(4);

	flashProducts = flashData ?? [];

	if (flashProducts.length === 0) {
		const { data: fallbackData } = await sb
			.from('fs_products')
			.select('id,name,slug,price_cents,stock,images')
			.eq('is_active', true)
			.order('price_cents', { ascending: true })
			.limit(4);
		flashProducts = fallbackData ?? [];
	}
}

const formatPrice = (priceCents: number) => formatPriceEURFromCents(priceCents);

const activeOffer = await getActiveFlashOffer(sb);
const discountPercent = activeOffer?.discount_percent ?? 0;
---

<StoreLayout title="Fashion Store">
	<section style="padding: 5rem 0; text-align: center; border-bottom: 1px solid #e5e7eb;">
		<div class="container">
			{brand.logoUrl ? (
				<img
					src={brand.logoUrl}
					alt={brand.name}
					loading="eager"
					style="height: 220px; width: auto; object-fit: contain; display: block; margin: 0 auto 1.25rem;"
				/>
			) : (
				<p style="font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: #6b7280; margin-bottom: 1rem;">
					{brand.name}
				</p>
			)}
			<p style="font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: #6b7280; margin-bottom: 1rem;">
				Nueva coleccion
			</p>
			<h1 style="font-size: 3rem; font-weight: 300; letter-spacing: -0.02em; margin: 0;">
				Descubre tu estilo
			</h1>
			<p style="font-size: 1rem; color: #6b7280; margin-top: 1rem; max-width: 480px; margin-left: auto; margin-right: auto;">
				Piezas atemporales diseñadas para el día a día. Calidad y elegancia en cada detalle.
			</p>
			<div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2.5rem; flex-wrap: wrap;">
				<a href="/productos" class="btn-primary">Ver productos</a>
				<a href="/carrito" class="btn-secondary">Ver carrito</a>
			</div>
			{heroImg && heroImg !== brand.logoUrl ? (
				<div style="max-width: 980px; margin: 3rem auto 0;">
					<img
						src={heroImg}
						alt={brand.name}
						loading="lazy"
						style="width: 100%; height: 340px; object-fit: cover; background: #f5f5f5;"
					/>
				</div>
			) : null}
		</div>
	</section>

	<section style="padding: 4rem 0;">
		<div class="container">
			<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
				<a
					href="/productos"
					style="display: block; padding: 3rem 2rem; border: 1px solid #e5e7eb; text-align: center; transition: border-color 0.2s;"
					onmouseover="this.style.borderColor='#111'"
					onmouseout="this.style.borderColor='#e5e7eb'"
				>
					<p style="font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: #9ca3af; margin-bottom: 0.75rem;">
						Categoria
					</p>
					<h3 style="font-size: 1.125rem; font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
						New In
					</h3>
				</a>

				<a
					href="/productos"
					style="display: block; padding: 3rem 2rem; border: 1px solid #e5e7eb; text-align: center; transition: border-color 0.2s;"
					onmouseover="this.style.borderColor='#111'"
					onmouseout="this.style.borderColor='#e5e7eb'"
				>
					<p style="font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: #9ca3af; margin-bottom: 0.75rem;">
						Categoria
					</p>
					<h3 style="font-size: 1.125rem; font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
						Basics
					</h3>
				</a>

				{settings?.flash_offers_enabled && (
					<a
						href="/productos?flash=1"
						style="display: block; padding: 3rem 2rem; border: 1px solid #e5e7eb; text-align: center; transition: border-color 0.2s;"
						onmouseover="this.style.borderColor='#111'"
						onmouseout="this.style.borderColor='#e5e7eb'"
					>
						<p style="font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: #9ca3af; margin-bottom: 0.75rem;">
							Promocion
						</p>
						<h3 style="font-size: 1.125rem; font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
							Ofertas Flash
						</h3>
					</a>
				)}
			</div>
		</div>
	</section>

	<!-- Flash Products -->
	{settings?.flash_offers_enabled && flashProducts.length > 0 && (
		<section style="padding: 0 0 4rem;">
			<div class="container">
				<div style="text-align: center; margin-bottom: 2.5rem;">
					<h2 style="font-size: 0.8125rem; font-weight: 500; letter-spacing: 0.15em; text-transform: uppercase; margin: 0;">
						Ofertas flash
					</h2>
				</div>
				<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 2rem;">
					{flashProducts.map((p) => (
						<article style="display: flex; flex-direction: column;">
							{(() => {
								const imagesRaw = p.images;
								const images = Array.isArray(imagesRaw) ? (imagesRaw as string[]) : [];
								const imageUrl = images.length > 0 ? images[0] : undefined;
								const href = p.slug ? `/productos/${encodeURIComponent(p.slug)}` : '/productos';
								return (
									<>
										<a href={href} style="display: block; margin-bottom: 1rem;">
											{imageUrl ? (
												<img
													src={imageUrl}
													alt={p.name}
													loading="lazy"
													style="width: 100%; aspect-ratio: 3/4; object-fit: cover; background: #f5f5f5;"
												/>
											) : (
												<div style="width: 100%; aspect-ratio: 3/4; background: #f5f5f5;" />
											)}
										</a>
										<a href={href} style="color: #111; text-decoration: none;">
											<h4 style="font-size: 0.9375rem; font-weight: 400; margin: 0 0 0.5rem;">{p.name}</h4>
										</a>
										<p style="font-size: 0.875rem; color: #111; margin: 0 0 0.25rem; font-weight: 500;">
										{(() => {
											const discounted = discountPercent > 0 ? applyPercentDiscountCents(p.price_cents, discountPercent) : p.price_cents;
											const hasDiscount = discountPercent > 0 && discounted < p.price_cents;
											return hasDiscount ? (
												<span style="display: inline-flex; align-items: baseline; gap: 0.5rem; flex-wrap: wrap;">
													<span style="color: #9ca3af; font-weight: 400; text-decoration: line-through;">{formatPrice(p.price_cents)}</span>
													<span style="color: #111;">{formatPrice(discounted)}</span>
													<span style="font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: #111;">-{discountPercent}%</span>
												</span>
											) : (
												<>{formatPrice(p.price_cents)}</>
											);
										})()}
									</p>
										<p style="font-size: 0.75rem; color: #9ca3af; margin: 0 0 1rem;">Stock: {p.stock}</p>
										<AddToCartButton client:load productId={p.id} name={p.name} priceCents={p.price_cents} stock={p.stock} imageUrl={imageUrl} />
									</>
								);
							})()}
						</article>
					))}
				</div>
			</div>
		</section>
	)}

	<CartPanel client:only="preact" />
</StoreLayout>
