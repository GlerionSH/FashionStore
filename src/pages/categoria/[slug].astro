---
import StoreLayout from '../../layouts/StoreLayout.astro';
import { supabase } from '../../lib/supabase';
import AddToCartButton from '../../components/islands/AddToCartButton.tsx';
import { applyPercentDiscountCents, getActiveFlashOffer } from '../../lib/flashOffer';
import { formatPriceEURFromCents } from '../../lib/price';
import { getLangFromCookie, getCategoryName, getProductName } from '../../lib/i18n';

type CategoryRow = {
	id: string;
	name: string;
	name_es?: string | null;
	name_en?: string | null;
	slug: string;
};

type ProductRow = {
	id: string;
	name: string;
	name_es?: string | null;
	name_en?: string | null;
	slug: string;
	price_cents: number;
	stock: number;
	category_id: string;
	images: unknown;
	is_active: boolean;
};

const { slug } = Astro.params;
const categorySlug = slug ?? '';
const decodedCategorySlug = decodeURIComponent(categorySlug);

const sb = supabase as any;

const rawLangCookie = Astro.cookies.get('fs_lang')?.value ?? null;
const lang = getLangFromCookie(rawLangCookie);

const { data: categoryData, error: categoryError } = await sb
	.from('fs_categories')
	.select('id,name,name_es,name_en,slug')
	.eq('slug', decodedCategorySlug)
	.maybeSingle();

if (categoryError) {
	console.error('[categoria] categoryError:', categoryError);
}

const category: CategoryRow | null = categoryData ?? null;

let products: ProductRow[] = [];
let productsError: unknown = null;

if (category) {
	const { data: productsData, error } = await sb
		.from('fs_products')
		.select('id,name,name_es,name_en,slug,price_cents,stock,category_id,images,is_active')
		.eq('category_id', category.id)
		.eq('is_active', true)
		;

	products = productsData ?? [];
	productsError = error;

	if (productsError) {
		console.error('[categoria] productsError:', productsError);
	}
}

if (!category && !categoryError) {
	Astro.response.status = 404;
}

const formatPrice = (priceCents: number) => formatPriceEURFromCents(priceCents);

const activeOffer = await getActiveFlashOffer(sb);
const discountPercent = activeOffer?.discount_percent ?? 0;
const categoryDisplayName = category ? getCategoryName(category, lang) : null;

const pageTitle = `${
	categoryDisplayName || (lang === 'en' ? 'Category' : 'Categoría')
} - Fashion Store`;

const headingText = category
	? `${lang === 'en' ? 'Category' : 'Categoría'}: ${categoryDisplayName ?? ''}`
	: lang === 'en'
	? 'Category not found'
	: 'Categoría no encontrada';

const noProductsText =
	lang === 'en'
		? 'No products in this category.'
		: 'No hay productos en esta categoría.';

const notFoundText =
	lang === 'en' ? 'Category not found.' : 'Categoría no encontrada.';
---

<StoreLayout title={pageTitle}>
	<section class="card" style="max-width: 1200px; margin: 2rem auto;">
		<a class="btn-secondary" href="/productos">
			{lang === 'en' ? 'Back to products' : 'Volver a productos'}
		</a>
		<h1 style="margin-top: 1rem;">
			{headingText}
		</h1>
		{!category && !categoryError && <p class="helper-text">{notFoundText}</p>}

		<div
			style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem;"
		>
			{category && products.length === 0 && !productsError && <p>{noProductsText}</p>}
			{products.map((product) => (
				<article class="card">
					<h3>{getProductName(product, lang)}</h3>
					<div class="helper-text">Stock: {product.stock}</div>
					{(() => {
						const discounted = discountPercent > 0 ? applyPercentDiscountCents(product.price_cents, discountPercent) : product.price_cents;
						const hasDiscount = discountPercent > 0 && discounted < product.price_cents;
						return (
							<div style="margin-top: 0.75rem; font-weight: 600;">
								{hasDiscount ? (
									<span style="display: inline-flex; align-items: baseline; gap: 0.5rem; flex-wrap: wrap;">
										<span style="color: #9ca3af; font-weight: 400; text-decoration: line-through;">{formatPrice(product.price_cents)}</span>
										<span style="color: #111;">{formatPrice(discounted)}</span>
										<span style="font-size: 0.6875rem; letter-spacing: 0.15em; text-transform: uppercase; color: #111;">-{discountPercent}%</span>
									</span>
								) : (
									<>{formatPrice(product.price_cents)}</>
								)}
							</div>
						);
					})()}
					<AddToCartButton
						client:load
						productId={product.id}
						name={getProductName(product, lang)}
						priceCents={product.price_cents}
						stock={product.stock}
					/>
				</article>
			))}
		</div>
	</section>
</StoreLayout>
