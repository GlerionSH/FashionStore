---
import AdminFSLayout from '../../../layouts/AdminFSLayout.astro';
import { getSupabaseAdmin } from '../../../lib/database/supabaseServer';
import { formatPriceEURFromCents } from '../../../lib/price';

export const prerender = false;

const sb = getSupabaseAdmin() as any;

let error: string | null = null;

if (Astro.request.method === 'POST') {
	const form = await Astro.request.formData();
	const action = String(form.get('action') ?? '');
	const id = String(form.get('id') ?? '');

	if (action === 'delete' && id) {
		const { error: deleteError } = await sb.from('fs_products').delete().eq('id', id);
		if (deleteError) {
			error = deleteError.message || 'No se pudo eliminar el producto';
		} else {
			return Astro.redirect('/admin-fs/productos');
		}
	}
}

const { data: productsData, error: productsError } = await sb
	.from('fs_products')
	.select('id,name,slug,price_cents,stock,is_active')
	.order('name', { ascending: true });

if (productsError) {
	error = productsError.message || 'Error cargando productos';
}

type ProductRow = {
	id: string;
	name: string;
	slug: string;
	price_cents: number;
	stock: number;
	is_active: boolean;
};

const products: ProductRow[] = productsData ?? [];

const formatPrice = (priceCents: number) => formatPriceEURFromCents(priceCents);
---

<AdminFSLayout title="Admin FashionStore - Productos">
	<section style="padding: 3rem 0 4rem;">
		<div class="container">
			<div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1.5rem; flex-wrap: wrap;">
				<div>
					<p style="font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: #6b7280; margin-bottom: 0.75rem;">
						Catalogo
					</p>
					<h1 style="font-size: 1.5rem; font-weight: 400; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
						Productos
					</h1>
					<p class="helper-text" style="margin-top: 0.75rem; max-width: 640px;">
						Gestiona el catalogo de FashionStore
					</p>
				</div>
				<div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
					<a class="btn-secondary" href="/admin-fs">Volver</a>
					<a class="btn-primary" href="/admin-fs/productos/nuevo">Nuevo producto</a>
				</div>
			</div>

			{error && <div class="alert alert-error" style="margin-top: 1.5rem;">{error}</div>}

			<div style="margin-top: 2rem; border: 1px solid #e5e7eb; overflow-x: auto;">
				<table>
					<thead>
						<tr>
							<th>Nombre</th>
							<th>Slug</th>
							<th style="text-align: right;">Precio</th>
							<th style="text-align: right;">Stock</th>
							<th style="text-align: center;">Activo</th>
							<th style="text-align: right;">Acciones</th>
						</tr>
					</thead>
					<tbody>
						{products.map((p) => (
							<tr>
								<td style="font-weight: 500;">{p.name}</td>
								<td style="color: #6b7280;">{p.slug}</td>
								<td style="text-align: right;">{formatPrice(p.price_cents)}</td>
								<td style="text-align: right;">{p.stock}</td>
								<td style="text-align: center;">{p.is_active ? 'Si' : 'No'}</td>
								<td style="text-align: right;">
									<div style="display: inline-flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end;">
										<a class="btn-secondary" href={`/admin-fs/productos/${encodeURIComponent(p.id)}`} style="padding: 0.5rem 1rem;">Editar</a>
										<form method="POST" style="display: inline; margin: 0;">
											<input type="hidden" name="action" value="delete" />
											<input type="hidden" name="id" value={p.id} />
											<button class="btn-danger" type="submit" style="padding: 0.5rem 1rem;">Eliminar</button>
										</form>
									</div>
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>

			{products.length === 0 && !productsError && <p class="helper-text" style="margin-top: 1rem;">No hay productos</p>}
		</div>
	</section>
</AdminFSLayout>
