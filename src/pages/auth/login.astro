---
import StoreLayout from '../../layouts/StoreLayout.astro';
import { createClient } from '@supabase/supabase-js';
export const prerender = false;

let error: string | null = null;

const showResetBanner = Astro.url.searchParams.get('reset') === '1';

const nextParam = Astro.url.searchParams.get('next');
const safeNext =
	nextParam && nextParam.startsWith('/') && !nextParam.startsWith('//') ? nextParam : '/cuenta';

if (Astro.request.method === 'POST') {
	const form = await Astro.request.formData();
	const email = String(form.get('email') ?? '').trim();
	const password = String(form.get('password') ?? '');

	if (!email || !password) {
		error = 'Email y contraseña son requeridos';
	} else {
		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const anonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		if (!supabaseUrl || !anonKey) {
			error = 'Supabase no está configurado';
		} else {
			const sb = createClient(supabaseUrl, anonKey, {
				auth: { persistSession: false, autoRefreshToken: false },
			});

			const { data, error: signInError } = await sb.auth.signInWithPassword({
				email,
				password,
			});

			if (signInError || !data.session) {
				error = signInError?.message || 'No se pudo iniciar sesión';
			} else {
				Astro.cookies.set('sb-access-token', data.session.access_token, {
					path: '/',
					maxAge: data.session.expires_in,
					secure: import.meta.env.PROD,
					httpOnly: true,
					sameSite: 'lax',
				});

				Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
					path: '/',
					maxAge: 60 * 60 * 24 * 7,
					secure: import.meta.env.PROD,
					httpOnly: true,
					sameSite: 'lax',
				});

				if (data.user?.id) {
					Astro.cookies.set('sb-user-id', data.user.id, {
						path: '/',
						maxAge: data.session.expires_in,
						secure: import.meta.env.PROD,
						httpOnly: false,
						sameSite: 'lax',
					});
				}

				let isAdmin = false;
				try {
					const sbAuth = createClient(supabaseUrl, anonKey, {
						auth: { persistSession: false, autoRefreshToken: false },
						global: { headers: { Authorization: `Bearer ${data.session.access_token}` } },
					});

					const { data: userData, error: userError } = await sbAuth.auth.getUser();
					const userId = userData?.user?.id ?? data.user?.id;

					if (!userError && userId) {
						const { data: profile } = await (sbAuth as any)
							.from('fs_profiles')
							.select('role')
							.eq('id', userId)
							.maybeSingle();

						isAdmin = profile?.role === 'admin';
					}
				} catch {
					isAdmin = false;
				}

				if (isAdmin) {
					return Astro.redirect('/admin-fs');
				}

				return Astro.redirect(safeNext);
			}
		}
	}
}
---

<StoreLayout title="Iniciar sesion - Fashion Store" showAuth={false}>
	<section style="padding: 4rem 0;">
		<div class="container container-sm">
			<div style="text-align: center; margin-bottom: 2.5rem;">
				<h1 style="font-size: 1.5rem; font-weight: 400; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
					Iniciar sesion
				</h1>
				<p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem;">
					Accede a tu cuenta para ver tus pedidos
				</p>
			</div>

			{safeNext === '/carrito' && (
				<div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; text-align: center;">
					<p style="font-size: 0.8125rem; color: #6b7280; margin: 0;">
						Inicia sesion para finalizar tu compra
					</p>
				</div>
			)}

			{error && (
				<div class="alert alert-error" style="margin-bottom: 1.5rem;">{error}</div>
			)}
			{showResetBanner && (
				<div class="alert alert-success" style="margin-bottom: 1.5rem;">
					Contraseña actualizada. Inicia sesión con la nueva.
				</div>
			)}

			<form method="POST" style="display: grid; gap: 1.25rem;">
				<div>
					<label for="email" class="form-label">Email</label>
					<input class="form-input" type="email" id="email" name="email" required />
				</div>
				<div>
					<label for="password" class="form-label">Contraseña</label>
					<input class="form-input" type="password" id="password" name="password" required />
				</div>
				<button class="btn-primary" type="submit" style="width: 100%; margin-top: 0.5rem;">
					Entrar
				</button>
			</form>

			<div style="margin-top: 1rem; text-align: center; font-size: 0.8125rem;">
				<a href="/auth/forgot-password" style="color: #111; text-decoration: underline;">
					¿Olvidaste tu contraseña?
				</a>
			</div>

			<div style="margin-top: 2rem; text-align: center; font-size: 0.8125rem;">
				<p style="color: #6b7280; margin: 0 0 0.5rem;">
					¿No tienes cuenta?
					<a href="/auth/register" style="color: #111; text-decoration: underline; margin-left: 0.25rem;">Crear cuenta</a>
				</p>
				<p style="margin: 0;">
					<a href="/" style="color: #9ca3af; text-decoration: underline;">Volver al inicio</a>
				</p>
			</div>
		</div>
	</section>
</StoreLayout>
