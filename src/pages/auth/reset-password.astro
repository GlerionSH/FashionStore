---
import StoreLayout from '../../layouts/StoreLayout.astro';
import { getLangFromCookie } from '../../lib/i18n';

export const prerender = false;

const raw = Astro.cookies.get('fs_lang')?.value ?? null;
const lang = getLangFromCookie(raw);
---

<StoreLayout title={`${lang === 'en' ? 'Reset password' : 'Restablecer contraseña'} - Fashion Store`} showAuth={false}>
	<section style="padding: 4rem 0;">
		<div class="container container-sm">
			<div style="text-align: center; margin-bottom: 2.5rem;">
				<h1 style="font-size: 1.5rem; font-weight: 400; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
					{lang === 'en' ? 'Reset password' : 'Restablecer contraseña'}
				</h1>
				<p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem;">
					{lang === 'en' ? 'Choose a new password for your account' : 'Elige una nueva contraseña para tu cuenta'}
				</p>
			</div>

			<div id="alert" class="alert" style="display: none; margin-bottom: 1.5rem;"></div>

			<form id="resetForm" action="javascript:void(0)" style="display: grid; gap: 1.25rem;">
				<div>
					<label for="password" class="form-label">{lang === 'en' ? 'New password' : 'Nueva contraseña'}</label>
					<input class="form-input" type="password" id="password" name="password" minlength="8" required />
				</div>
				<div>
					<label for="confirm" class="form-label">{lang === 'en' ? 'Confirm password' : 'Confirmar contraseña'}</label>
					<input class="form-input" type="password" id="confirm" name="confirm" minlength="8" required />
				</div>
				<button id="submitBtn" class="btn-primary" type="submit" style="width: 100%; margin-top: 0.5rem;">
					{lang === 'en' ? 'Update password' : 'Actualizar contraseña'}
				</button>
			</form>

			<div style="margin-top: 2rem; text-align: center; font-size: 0.8125rem;">
				<p style="margin: 0;">
					<a href="/auth/login" style="color: #111; text-decoration: underline;">
						{lang === 'en' ? 'Go to login' : 'Ir a login'}
					</a>
				</p>
			</div>
		</div>
	</section>

	<script define:vars={{ lang }}>
		import { getSupabaseBrowser } from '../../lib/supabase/browser';

		const showAlert = (kind, message) => {
			const el = document.getElementById('alert');
			if (!el) return;
			el.style.display = 'block';
			el.textContent = message;
			el.style.background = kind === 'error' ? '#fee2e2' : '#d1fae5';
			el.style.color = kind === 'error' ? '#991b1b' : '#065f46';
		};

		const setSubmitDisabled = (disabled) => {
			const btn = document.getElementById('submitBtn');
			if (!(btn instanceof HTMLButtonElement)) return;
			btn.disabled = disabled;
		};

		const clearRecoveryUrlTokens = () => {
			try {
				const url = new URL(window.location.href);
				url.hash = '';
				url.searchParams.delete('code');
				history.replaceState(null, '', url.pathname + url.search);
			} catch {
				// ignore
			}
		};

		const parseRecoveryHash = () => {
			const raw = (window.location.hash || '').replace(/^#/, '');
			if (!raw) return null;
			const hash = new URLSearchParams(raw);
			const access_token = hash.get('access_token');
			const refresh_token = hash.get('refresh_token');
			const type = hash.get('type');
			if (type !== 'recovery' || !access_token || !refresh_token) return null;
			return { access_token, refresh_token };
		};

		const setRecoverySessionFromHashIfNeeded = async (supabase) => {
			const recovery = parseRecoveryHash();
			if (recovery) {
				const { error } = await supabase.auth.setSession(recovery);
				if (error) {
					console.info('[reset] hasSessionAfterSet', false);
					return false;
				}
				const { data: afterSet } = await supabase.auth.getSession();
				console.info('[reset] hasSessionAfterSet', Boolean(afterSet.session));
				clearRecoveryUrlTokens();
				return Boolean(afterSet.session);
			}

			const { data: existing } = await supabase.auth.getSession();
			console.info('[reset] hasSessionAfterSet', Boolean(existing.session));
			return Boolean(existing.session);
		};

		const setFormEnabled = (enabled) => {
			const form = document.getElementById('resetForm');
			if (!(form instanceof HTMLFormElement)) return;
			form.querySelectorAll('input,button').forEach((el) => {
				if (el instanceof HTMLInputElement || el instanceof HTMLButtonElement) {
					el.disabled = !enabled;
				}
			});
		};

		(async () => {
			try {
				const supabase = getSupabaseBrowser();
				setFormEnabled(false);
				const ok = await setRecoverySessionFromHashIfNeeded(supabase);
				if (!ok) {
					showAlert('error', lang === 'en' ? 'The link has expired. Please request a new one.' : 'El enlace ha expirado. Vuelve a pedir uno nuevo.');
					setFormEnabled(false);
					return;
				}
				setFormEnabled(true);
			} catch {
				showAlert('error', lang === 'en' ? 'Could not initialize the recovery form.' : 'No se pudo inicializar el formulario de recuperación.');
				setFormEnabled(false);
			}
		})();

		document.getElementById('resetForm')?.addEventListener('submit', async (e) => {
			e.preventDefault();
			e.stopPropagation();
			const passwordEl = document.getElementById('password');
			const confirmEl = document.getElementById('confirm');
			const password = passwordEl instanceof HTMLInputElement ? passwordEl.value : '';
			const confirm = confirmEl instanceof HTMLInputElement ? confirmEl.value : '';

			if (password.length < 8) {
				showAlert('error', lang === 'en' ? 'Password must be at least 8 characters long' : 'La contraseña debe tener mínimo 8 caracteres');
				return;
			}
			if (password !== confirm) {
				showAlert('error', lang === 'en' ? 'Passwords do not match' : 'Las contraseñas no coinciden');
				return;
			}

			try {
				setSubmitDisabled(true);
				const supabase = getSupabaseBrowser();
				await setRecoverySessionFromHashIfNeeded(supabase);

				const { data: s1 } = await supabase.auth.getSession();
				console.info('[reset] hasSessionBeforeUpdate', Boolean(s1.session));
				if (!s1.session) {
					showAlert('error', lang === 'en' ? 'Invalid or expired link. Please request a new one.' : 'Enlace inválido o expirado. Vuelve a pedir uno nuevo.');
					return;
				}

				const { error } = await supabase.auth.updateUser({ password });
				console.info('[reset] updateUser ok?', !error);
				if (error) {
					showAlert('error', error.message || (lang === 'en' ? 'Could not update password' : 'No se pudo actualizar la contraseña'));
					return;
				}

				const { error: signOutError } = await supabase.auth.signOut();
				console.info('[reset] signOut ok?', !signOutError);
				window.location.href = '/auth/login?reset=1';
			} catch (err) {
				console.error('[reset] unexpected', err instanceof Error ? err.message : String(err));
				showAlert('error', lang === 'en' ? 'Error processing the request' : 'Error al procesar la solicitud');
			} finally {
				setSubmitDisabled(false);
			}
		});
	</script>
</StoreLayout>
