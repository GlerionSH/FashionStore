---
import StoreLayout from '../../layouts/StoreLayout.astro';
import { createClient } from '@supabase/supabase-js';
import { getLangFromCookie } from '../../lib/i18n';

export const prerender = false;

let error: string | null = null;
let success: string | null = null;
let cooldownSeconds: number | null = null;

const raw = Astro.cookies.get('fs_lang')?.value ?? null;
const lang = getLangFromCookie(raw);

const safeTrim = (v: unknown) => (typeof v === 'string' ? v.trim() : '');

if (Astro.request.method === 'POST') {
	const form = await Astro.request.formData();
	const email = safeTrim(form.get('email'));

	if (!email || !email.includes('@')) {
		error = lang === 'en' ? 'Enter a valid email' : 'Introduce un email válido';
	} else {
		const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
		const anonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
		const publicSiteUrl = (import.meta.env.PUBLIC_SITE_URL || process.env.PUBLIC_SITE_URL || '').trim();

		if (!supabaseUrl || !anonKey) {
			error = lang === 'en' ? 'Supabase is not configured' : 'Supabase no está configurado';
		} else if (!publicSiteUrl) {
			error = lang === 'en' ? 'PUBLIC_SITE_URL missing' : 'Falta PUBLIC_SITE_URL';
		} else {
			const siteBase = publicSiteUrl.replace(/\/+$/, '');
			const redirectTo = `${siteBase}/auth/reset-password`;

			const sb = createClient(supabaseUrl, anonKey, {
				auth: { persistSession: false, autoRefreshToken: false },
			});

			const { error: resetError } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
			if (resetError) {
				const status = (resetError as any).status;
				if (status === 429) {
					const msg = String(resetError.message || '');
					const match =
						msg.match(/after\s+(\d+)\s+seconds?/i) ||
						msg.match(/despu[eé]s\s+de\s+(\d+)\s+segundos?/i);
					cooldownSeconds = match ? Math.max(1, parseInt(match[1] || '0', 10) || 0) : 60;
					error =
						lang === 'en'
							? `For your security, you can only request it every so often. Wait ${cooldownSeconds} seconds and try again.`
							: `Por seguridad, solo puedes solicitarlo cada cierto tiempo. Espera ${cooldownSeconds} segundos y vuelve a intentarlo.`;
				} else {
					console.error('[forgot-password] resetPasswordForEmail error', {
						message: resetError.message,
						status,
					});
				}
			}

			if (!cooldownSeconds) {
				success =
					lang === 'en'
						? 'If an account exists with that email, we have sent you a link to reset your password.'
						: 'Si existe una cuenta con ese email, te hemos enviado un enlace para restablecer tu contraseña.';
			}
		}
	}
}
---

<StoreLayout title={`${lang === 'en' ? 'Recover password' : 'Recuperar contraseña'} - Fashion Store`} showAuth={false}>
	<section style="padding: 4rem 0;">
		<div class="container container-sm">
			<div style="text-align: center; margin-bottom: 2.5rem;">
				<h1 style="font-size: 1.5rem; font-weight: 400; letter-spacing: 0.05em; text-transform: uppercase; margin: 0;">
					{lang === 'en' ? 'Recover password' : 'Recuperar contraseña'}
				</h1>
				<p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem;">
					{lang === 'en'
						? 'We will send you a link to reset it'
						: 'Te enviaremos un enlace para restablecerla'}
				</p>
			</div>

			{error && <div class="alert alert-error" style="margin-bottom: 1.5rem;">{error}</div>}
			{success && <div class="alert alert-success" style="margin-bottom: 1.5rem;">{success}</div>}

			<form method="POST" style="display: grid; gap: 1.25rem;">
				<div>
					<label for="email" class="form-label">Email</label>
					<input class="form-input" type="email" id="email" name="email" required />
				</div>
				<button
					id="submitBtn"
					class="btn-primary"
					type="submit"
					style="width: 100%; margin-top: 0.5rem;"
				>
					{lang === 'en' ? 'Send link' : 'Enviar enlace'}
				</button>
			</form>

			<div style="margin-top: 2rem; text-align: center; font-size: 0.8125rem;">
				<p style="margin: 0;">
					<a href="/auth/login" style="color: #111; text-decoration: underline;">
						{lang === 'en' ? 'Back to login' : 'Volver a login'}
					</a>
				</p>
			</div>
		</div>
	</section>

	<script define:vars={{ cooldownSeconds, lang }}>
		(() => {
			const seconds = Number(cooldownSeconds || 0);
			const btn = document.getElementById('submitBtn');
			if (!(btn instanceof HTMLButtonElement)) return;
			if (!Number.isFinite(seconds) || seconds <= 0) return;

			let remaining = Math.trunc(seconds);
			btn.disabled = true;

			const originalText =
				btn.textContent || (lang === 'en' ? 'Send link' : 'Enviar enlace');
			const tick = () => {
				if (remaining <= 0) {
					btn.disabled = false;
					btn.textContent = originalText;
					return;
				}
				btn.textContent =
					lang === 'en' ? `Wait ${remaining}s…` : `Espera ${remaining}s…`;
				remaining -= 1;
				setTimeout(tick, 1000);
			};
			tick();
		})();
	</script>
</StoreLayout>

