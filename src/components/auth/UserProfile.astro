---
/**
 * Componente de perfil de usuario
 * Muestra el usuario actual y opciones de logout
 */
---

<div class="user-profile">
  <button class="profile-button" id="profileBtn">
    <div class="avatar" id="avatar">
      <span id="initials">U</span>
    </div>
    <span class="username" id="username">Usuario</span>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div class="profile-menu" id="profileMenu">
    <div class="menu-header">
      <div class="menu-avatar" id="menuAvatar">
        <span id="menuInitials">U</span>
      </div>
      <div class="menu-info">
        <div class="menu-name" id="menuName">Usuario</div>
        <div class="menu-email" id="menuEmail">usuario@email.com</div>
      </div>
    </div>

    <hr class="menu-divider" />

    <a href="/profile" class="menu-item">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <span>Mi Perfil</span>
    </a>

    <a href="/settings" class="menu-item">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m2.12 2.12l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m2.12-2.12l4.24-4.24"></path>
      </svg>
      <span>Configuración</span>
    </a>

    <hr class="menu-divider" />

    <button class="menu-item logout-btn" id="logoutBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2z"></path>
        <polyline points="16 8 16 3 8 3 8 8"></polyline>
        <line x1="9" y1="13" x2="15" y2="13"></line>
      </svg>
      <span>Cerrar Sesión</span>
    </button>
  </div>
</div>

<script>
  const profileBtn = document.getElementById('profileBtn');
  const profileMenu = document.getElementById('profileMenu');
  const logoutBtn = document.getElementById('logoutBtn');

  // Cargar información del usuario
  async function loadUserInfo() {
    try {
      const response = await fetch('/api/auth/me');
      const data = await response.json();

      if (data.success && data.user) {
        const user = data.user;
        const fullName = user.user_metadata?.full_name || 'Usuario';
        const email = user.email || 'usuario@email.com';
        const initials = getInitials(fullName);

        // Actualizar interfaz
        const usernameEl = document.getElementById('username');
        const initialsEl = document.getElementById('initials');
        const menuNameEl = document.getElementById('menuName');
        const menuEmailEl = document.getElementById('menuEmail');
        const menuInitialsEl = document.getElementById('menuInitials');
        const avatarEl = document.getElementById('avatar');
        const menuAvatarEl = document.getElementById('menuAvatar');

        if (usernameEl) usernameEl.textContent = fullName;
        if (initialsEl) initialsEl.textContent = initials;
        if (menuNameEl) menuNameEl.textContent = fullName;
        if (menuEmailEl) menuEmailEl.textContent = email;
        if (menuInitialsEl) menuInitialsEl.textContent = initials;
        if (avatarEl) avatarEl.style.backgroundColor = generateColor(email);
        if (menuAvatarEl) menuAvatarEl.style.backgroundColor = generateColor(email);
      }
    } catch (error) {
      console.error('Error cargando información del usuario:', error);
    }
  }

  // Obtener iniciales del nombre
  function getInitials(name: string): string {
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase()
      .substring(0, 2);
  }

  // Generar color consistente basado en email
  function generateColor(email: string): string {
    const colors = [
      '#6366f1', // indigo
      '#8b5cf6', // purple
      '#ec4899', // pink
      '#f43f5e', // rose
      '#f97316', // orange
      '#eab308', // yellow
      '#84cc16', // lime
      '#10b981', // emerald
      '#14b8a6', // teal
      '#06b6d4', // cyan
      '#0ea5e9', // sky
      '#3b82f6', // blue
    ];

    let hash = 0;
    for (let i = 0; i < email.length; i++) {
      hash = email.charCodeAt(i) + ((hash << 5) - hash);
    }

    return colors[Math.abs(hash) % colors.length];
  }

  // Alternar menú de perfil
  if (profileBtn && profileMenu) {
    profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle('active');
    });
  }

  // Cerrar menú al hacer click fuera
  document.addEventListener('click', (e) => {
    if (profileBtn && profileMenu) {
      const target = e.target as Node;
      if (!profileBtn.contains(target) && !profileMenu.contains(target)) {
        profileMenu.classList.remove('active');
      }
    }
  });

  // Cerrar sesión
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = '/auth/login';
        }
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        alert('Error al cerrar sesión');
      }
    });
  }

  // Cargar información del usuario al montar
  loadUserInfo();
</script>

<style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --dark: #1f2937;
    --light: #f9fafb;
    --border: #e5e7eb;
    --text: #374151;
    --error: #ef4444;
  }

  .user-profile {
    position: relative;
  }

  .profile-button {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: white;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .profile-button:hover {
    background: var(--light);
    border-color: var(--primary);
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    background: var(--primary);
  }

  .username {
    color: var(--dark);
    font-weight: 500;
    font-size: 0.9rem;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .profile-button svg {
    color: var(--text);
    transition: transform 0.3s ease;
  }

  .profile-button:hover svg {
    transform: rotate(180deg);
  }

  .profile-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    width: 320px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .profile-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .menu-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
  }

  .menu-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    background: var(--primary);
    flex-shrink: 0;
  }

  .menu-info {
    flex: 1;
    min-width: 0;
  }

  .menu-name {
    font-weight: 600;
    color: var(--dark);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .menu-email {
    font-size: 0.85rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .menu-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 0;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--text);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
    text-align: left;
    font-family: inherit;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .menu-item:hover {
    background: var(--light);
    color: var(--primary);
  }

  .menu-item svg {
    color: currentColor;
    flex-shrink: 0;
  }

  .logout-btn {
    color: var(--error);
  }

  .logout-btn:hover {
    background: rgba(239, 68, 68, 0.1);
  }
</style>
